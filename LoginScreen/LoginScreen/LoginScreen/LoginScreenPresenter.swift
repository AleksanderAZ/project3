//
//  LoginScreenPresenter.swift
//  LoginScreen
//
//  Created Z on 1/16/20.
//  Copyright Â© 2020 Zyma. All rights reserved.
//
//  Template generated by Juanpe CatalÃ¡n @JuanpeCMiOS
//

import UIKit

class LoginScreenPresenter: LoginScreenPresenterProtocol {

    weak private var view: LoginScreenViewProtocol?
    var interactor: LoginScreenInteractorProtocol?
    private let router: LoginScreenWireframeProtocol
    
    var passwordText: String = ""
    let charHidePassword: Character = "â—"
    
    var statusHidePassword: Bool = true
    
    init(interface: LoginScreenViewProtocol, interactor: LoginScreenInteractorProtocol?, router: LoginScreenWireframeProtocol) {
        self.view = interface
        self.interactor = interactor
        self.router = router
    }
    
    func setLogin(login: String) {
        interactor?.setLogin(login: login)
        update()
    }
    
    func setPassword(password: String) {
        var passwordNew = password
        if (isHidePassword()) {
            let password = interactor?.getPassword() ?? ""
            passwordNew = changeHidePassword(password: password, passwordHide: passwordNew)
        }
        interactor?.setPassword(password: password)
        update()
    }
    
    // MARK:  finaly check passwor and login
    func update() {
        guard let loginStatus = interactor?.getStatusLogin()  else { return }
        guard loginStatus else { view?.switchOffPasswordTextFild(); return }
        view?.switchOnPasswordTextFild()
        guard let passwordStatus = interactor?.getStatusPassword()  else { return }
        guard passwordStatus else { view?.switchOffLoginButton() ; return }
        view?.switchOnLoginButton()
    }
    
    func isHidePassword()-> Bool {
        return statusHidePassword
    }
    
    func changeHidePassword()->String {
        statusHidePassword = !statusHidePassword
        if (isHidePassword()) {
            view?.setTittlePasswordButton(tittle: "ðŸ”“")
            return String(repeating: charHidePassword, count: passwordText.count)
        }
        else {
            view?.setTittlePasswordButton(tittle: "ðŸ”’")
            return passwordText
        }
        
    }
    
    func cleanPassword()->String {
        passwordText.removeAll()
        view?.switchOffLoginButton()
        return ""
    }
    
    func changeHidePassword(password: String, passwordHide: String)->String {
        guard (passwordHide.count > 0) else { return ""}
        guard (passwordHide.count >= password.count) else { return "" }
        guard (passwordHide.count > password.count) else { return password }
        guard let _ = passwordHide.lastIndex(where: {$0 != charHidePassword}) else { return "" }
        var newPassword = ""
        for char in passwordHide {
            if (char == charHidePassword) {
                newPassword.append(passwordText.removeFirst())
            }
            else {
                newPassword.append(char)
            }
        }
        return newPassword
    }
    
    func getPasswordForShow()->String {
        guard let password = interactor?.getPassword() else { return "" }
        if (isHidePassword()) {
            return String(repeating: charHidePassword, count: password.count)
        }
        else {
            return password
        }
    }
    
    func clickLogin() {
        router.login(login: interactor?.getLogin() ?? "", password: interactor?.getPassword() ?? "")
    }
    
    func openLink() {
        router.openLink()
    }
}
