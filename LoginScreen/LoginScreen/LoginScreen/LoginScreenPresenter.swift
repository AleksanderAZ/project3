//
//  LoginScreenPresenter.swift
//  LoginScreen
//
//  Created Z on 1/16/20.
//  Copyright © 2020 Zyma. All rights reserved.
//
//  Template generated by Juanpe Catalán @JuanpeCMiOS
//

import UIKit

class LoginScreenPresenter: LoginScreenPresenterProtocol {

    weak private var view: LoginScreenViewProtocol?
    var interactor: LoginScreenInteractorProtocol?
    private let router: LoginScreenWireframeProtocol
    
    var statusHidePassword: Bool = true
    
    init(interface: LoginScreenViewProtocol, interactor: LoginScreenInteractorProtocol?, router: LoginScreenWireframeProtocol) {
        self.view = interface
        self.interactor = interactor
        self.router = router
    }
    
    func setLogin(login: String) {
        interactor?.setLogin(login: login)
        updateView()
        updateViewNew()
    }
    
    func setPassword(password: String) {
        var passwordNew = password
        if (isHidePassword()) {
            let password = interactor?.getPassword() ?? ""
            passwordNew = interactor?.changeHidePassword(password: password, passwordHide: passwordNew) ?? ""
        }
        interactor?.setPassword(password: passwordNew)
        updateView()
        updateViewNew()
    }
    
    // MARK:  finaly check passwor and login
    func updateView() {
        guard let loginStatus = interactor?.getStatusLogin()  else { return }
        guard loginStatus else {
            //view?.switchOffPasswordTextFild();
            view?.switchLoginButton(isHide: true)
            view?.switchPasswordTextFild(isHide: true)
            return
        }
        //view?.switchOnPasswordTextFild()
        view?.switchPasswordTextFild(isHide: false)
        guard let passwordStatus = interactor?.getStatusPassword()  else { return }
        guard passwordStatus else {
            view?.switchLoginButton(isHide: true)
            //view?.switchOffLoginButton() ;
            return
        }
        //view?.switchOnLoginButton()
        view?.switchLoginButton(isHide: false)
    }
    
    func isHidePassword()-> Bool {
        return statusHidePassword
    }
    
    func updateViewNew() {
        guard let interactor = interactor else { return }
        let checkLogin: Check = interactor.getStatusCheckLogin()
        if case .no(let error) = checkLogin {
            print(error)
            view?.switchLoginButton(isHide: true)
            view?.switchPasswordTextFild(isHide: true)
            return
        }
        view?.switchPasswordTextFild(isHide: false)
        let checkPassword: Check = interactor.getStatusCheckPassword()
        if case .no(let error) = checkPassword {
            print(error)
            view?.switchLoginButton(isHide: true)
            return
        }
        view?.switchLoginButton(isHide: false)
    }
    
    func changeHidePassword()->String {
        statusHidePassword = !statusHidePassword
        if (isHidePassword()) {
            view?.setTittlePasswordButtonShow()
        }
        else {
            view?.setTittlePasswordButtonHide()
        }
        return getPasswordForShow()
    }
    
    func getPasswordForShow()->String {
        guard let password = interactor?.getPassword() else { return "" }
        if (isHidePassword()) {
            return String(repeating: CharactersChecking.charHidePassword, count: password.count)
        }
        else {
            return password
        }
    }
    
    func clickLogin() {
        router.login(login: interactor?.getLogin() ?? "", password: interactor?.getPassword() ?? "")
    }
    
    func openLink() {
        router.openLink()
    }
}
